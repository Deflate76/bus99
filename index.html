<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <!-- ✅ 모바일 반응형 필수 뷰포트 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="HandheldFriendly" content="true" />
  <title>버스 시간표 (99번 / 2-1번)</title>
  <style>
    /* 0) 박스 계산 안정화 */
    *, *::before, *::after { box-sizing: border-box; }

    /* ✅ 크롬 자동 글자 확대 방지 */
    html { -webkit-text-size-adjust: 100%; }
    body {
      font-family: Arial, Helvetica, "Noto Sans KR", system-ui;
      background:#f5f5f5;
      margin:0;
    }

    .selectors {
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      padding:12px 16px;
      background:#333;
      color:#fff;
      align-items:center;
    }
    .selectors label {
      flex:1 1 48%;
      min-width:0; /* ✅ flex 자식 폭 밀림 방지 */
    }
    select { padding:6px 8px }
    .info { padding:10px 16px; background:#eee; color:#222 }

    /* ✅ 가로 스크롤은 테이블 컨테이너 안에서만 */
    .table-container {
      padding:16px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      width:100%;
      max-width:100vw;
      display:block;
    }

    /* 테이블 공통 */
    table {
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }
    th, td {
      border:1px solid #999;
      padding:6px;
      text-align:center;
      white-space:nowrap;
    }
    th { background:#eee }

    /* 데스크톱 sticky 헤더/첫열 */
    @media (min-width: 769px) {
      table thead th { position: sticky; top: 0; z-index: 2; }
      table th:first-child, table td:first-child {
        position: sticky;
        left: 0;
        background:#fafafa;
        z-index: 3;
      }
    }

    /* ✅ 모바일 최적화 */
    @media (max-width: 768px) {
      html, body { width:100%; max-width:100vw; overflow-x:hidden; } /* 루트 오버플로우 차단 */

      body { font-size: 14px; }
      .selectors { gap:8px; }
      .selectors label { width: calc(50% - 8px); }
      .selectors select { width: 100%; padding:10px; font-size:16px; }
      .info { font-size: 13px; line-height: 1.4; }
      table { font-size: 13px; }
      th, td { padding: 8px 10px; }
      table thead th, table th:first-child, table td:first-child {
        position: static !important; /* sticky 강제 해제 */
      }
    }

    @media (max-width: 420px) {
      body { font-size: 13px; }
      .selectors label { width:100%; }
      .info { font-size: 12px; }
      table { font-size: 12px; }
      th, td { padding: 6px 8px; }
    }

    /* 이미지, select 등 폭 초과 방지 */
    img, table, select { max-width:100%; }

    .cell-prev { background:#c8e6c9 !important }
    .cell-next { background:#fff59d !important }
  </style>
</head>
<body>
  <div class="selectors">
    <label>노선:
      <select id="routeSelect">
        <option value="99번" selected>99번</option>
        <option value="2-1번">2-1번</option>
      </select>
    </label>
    <label>출발 방향:
      <select id="directionSelect"></select>
    </label>
  </div>
  <div class="info" id="infoBox">로딩 중…</div>
  <div class="table-container" id="tableContainer"></div>

<script>
/* ===================== 데이터 ===================== */
const timetable = { /* (생략 — 원본 동일) */ };
const directionOptions = {
  "99번": ["성복역", "상현역"],
  "2-1번": ["죽전역", "구성역"]
};

function updateDirectionOptions() {
  const route = document.getElementById('routeSelect').value;
  const dirSelect = document.getElementById('directionSelect');
  dirSelect.innerHTML = '';
  (directionOptions[route]||[]).forEach((d,i)=>{
    const opt = document.createElement('option');
    opt.value = d; opt.textContent = d;
    if(i===0) opt.selected=true;
    dirSelect.appendChild(opt);
  });
}

function getDayType(){ const dow=new Date().getDay(); return dow===0?'holiday':(dow===6?'saturday':'weekday'); }
function getDayLabel(k){ return k==='holiday'?'공휴일':(k==='saturday'?'토요일':'평일'); }

function renderTable(){
  const now = new Date();
  const dayKey = getDayType();
  const route = document.getElementById('routeSelect').value;
  const direction = document.getElementById('directionSelect').value;
  const container = document.getElementById('tableContainer');
  const infoBox = document.getElementById('infoBox');
  container.innerHTML = '';

  infoBox.textContent = `오늘은 ${now.toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric',weekday:'long'})} (${getDayLabel(dayKey)}), 현재 시각: ${now.toLocaleTimeString('ko-KR')}`;

  const data = (timetable[dayKey]||{})[route];
  if(!data || !data.length){ container.textContent='해당 데이터가 없습니다'; return; }

  const colsPerRow = data[0].length;
  let dirCols=[];
  if(route==='99번'){
    const start = (direction==='상현역')?1:2;
    for(let i=start;i<colsPerRow;i+=2) dirCols.push(i);
  } else if(route==='2-1번'){
    const start = (direction==='구성역')?1:2;
    for(let i=start;i<colsPerRow;i+=2) dirCols.push(i);
  }

  const table=document.createElement('table');
  const theadRow=document.createElement('tr');
  theadRow.appendChild(Object.assign(document.createElement('th'),{innerText:'회차'}));
  dirCols.forEach((_,idx)=>
    theadRow.appendChild(Object.assign(document.createElement('th'),{innerText:`${idx+1}호차 ${direction}`}))
  );
  const thead=document.createElement('thead'); thead.appendChild(theadRow);
  table.appendChild(thead);

  const tbody=document.createElement('tbody');
  for(const row of data){
    const tr=document.createElement('tr');
    tr.appendChild(Object.assign(document.createElement('td'),{innerText:row[0]}));
    dirCols.forEach(c=>tr.appendChild(Object.assign(document.createElement('td'),{innerText:row[c]||''})));
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  container.appendChild(table);
  highlight(table);
}

function highlight(table){
  const now=new Date(); const cur=now.getHours()*60+now.getMinutes();
  const rows=table.querySelectorAll('tr'); if(!rows.length) return;
  table.querySelectorAll('td').forEach(el=>el.classList.remove('cell-prev','cell-next'));
  const pts=[];
  for(let r=1;r<rows.length;r++){
    const tds=rows[r].querySelectorAll('td');
    for(let c=1;c<tds.length;c++){
      const m=tds[c].innerText.match(/^(\d{1,2}):(\d{2})$/);
      if(!m) continue;
      const mins=parseInt(m[1])*60+parseInt(m[2]);
      pts.push({r,c,mins});
    }
  }
  if(!pts.length) return;
  pts.sort((a,b)=>a.mins-b.mins);
  let prev=null,next=null;
  for(const p of pts){ if(p.mins<=cur) prev=p; if(p.mins>cur){ next=p; break; } }
  if(!next) next=pts[0]; if(!prev) prev=pts[pts.length-1];
  const pc=rows[prev.r].querySelectorAll('td')[prev.c];
  const nc=rows[next.r].querySelectorAll('td')[next.c];
  if(pc) pc.classList.add('cell-prev');
  if(nc) nc.classList.add('cell-next');
}

/* 초기화 */
updateDirectionOptions();
renderTable();

/* 이벤트 */
document.getElementById('routeSelect').addEventListener('change', ()=>{ updateDirectionOptions(); renderTable(); });
document.getElementById('directionSelect').addEventListener('change', renderTable);
setInterval(renderTable, 30000);
</script>
</body>
</html>
